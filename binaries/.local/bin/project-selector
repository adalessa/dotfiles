#!/bin/env sh
projects=()
pro=()

project_dirs=(
    "/home/$USER/code/*/"
    "/home/$USER/code/go/src/*/*/"
)

for directory in "${project_dirs[@]}"
do
    for p in "${directory}*"
    do
        projects+=($p)
    done
done

for p in "${projects[@]}"
do
    if [ "$p" = /home/$USER/code/go/src ]; then
        echo
    else
        pro+=($p)
    fi
done

selected=$(printf "%s\n" "${pro[@]}" | fzf)

[ -z $selected ] && exit

if [ ! -f "$selected/.project.sh" ]; then
    project=$(basename $selected)
    sessions=$(tmux ls | grep $project: | wc -l)
    if [ $sessions -eq 0 ]; then
        tmux new-session -d -s "$project" "cd "$selected" && nvim"
    fi

    tmux switch -t "${project}"
else
    "$selected"/.project.sh
fi

exit 0
